# Repository: data-extractor

Below are the files you can create in your GitHub repo. Paths are shown as headers; copy each block into the matching file path.

---

## .env.example
```
# Backend
APP_ENV=development
APP_PORT=8000
CORS_ORIGINS=*

# Frontend
VITE_API_URL=http://localhost:8000
```

---

## README.md
```
# Legacy Data Extractor – Light Start

FastAPI backend + React (Vite) frontend. Upload a CSV, preview the parsed rows.

## Local Quickstart (no Docker)

### 1) Backend
```bash
cd backend
python -m venv .venv && source .venv/bin/activate  # Windows: .venv\\Scripts\\activate
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8000
```

### 2) Frontend (new terminal)
```bash
cd frontend
npm install
npm run dev
```
Open http://localhost:5173 and set VITE_API_URL in `.env` (defaults to http://localhost:8000).

---

## Local with Docker
```bash
docker compose up --build
```
Frontend: http://localhost:5173  •  Backend: http://localhost:8000

---

## Deploy on Render
1. Push this repo to GitHub.
2. Render will read `infra/render.yaml` and create two services:
   - **data-extractor-api** (FastAPI)
   - **data-extractor-web** (Static site)
3. In the web service, set env var `VITE_API_URL` to the backend’s public URL.

---

## Project Structure
```
backend/
  app/
    __init__.py
    main.py
    routes.py
    utils.py
  requirements.txt
frontend/
  index.html
  package.json
  vite.config.js
  src/
    main.jsx
    App.jsx
    components/
      UploadForm.jsx
      DataTable.jsx
infra/
  docker-compose.yml
  render.yaml
.env.example
```

---

## Notes
- The backend limits preview to the first 500 rows for speed; you can adjust in `routes.py`.
- CORS is enabled for development; restrict `CORS_ORIGINS` in production.
```

---

## backend/requirements.txt
```
fastapi==0.115.2
uvicorn[standard]==0.30.6
python-multipart==0.0.9
pydantic==2.9.2
```

---

## backend/app/__init__.py
```
# empty on purpose
```

---

## backend/app/utils.py
```
from typing import List, Dict
import csv
import io


def sniff_delimiter(sample: bytes) -> str:
    try:
        dialect = csv.Sniffer().sniff(sample.decode("utf-8", errors="ignore"))
        return dialect.delimiter
    except Exception:
        return ","


def read_csv_bytes(data: bytes, max_rows: int = 500) -> Dict[str, List[Dict]]:
    sample = data[:4096]
    delimiter = sniff_delimiter(sample)

    text = data.decode("utf-8", errors="replace")
    reader = csv.reader(io.StringIO(text), delimiter=delimiter)

    rows = list(reader)
    if not rows:
        return {"headers": [], "rows": []}

    headers = rows[0]
    out_rows = []
    for r in rows[1:max_rows+1]:
        # pad shorter rows
        padded = r + [""] * (len(headers) - len(r))
        out_rows.append({h: padded[i] if i < len(padded) else "" for i, h in enumerate(headers)})

    return {"headers": headers, "rows": out_rows}
```

---

## backend/app/routes.py
```
from fastapi import APIRouter, UploadFile, File, HTTPException
from .utils import read_csv_bytes

router = APIRouter(prefix="/api", tags=["api"])


@router.get("/health")
async def health():
    return {"status": "ok"}


@router.post("/upload")
async def upload_csv(file: UploadFile = File(...)):
    if not file.filename.lower().endswith((".csv", ".txt")):
        raise HTTPException(status_code=400, detail="Please upload a .csv file")

    data = await file.read()
    parsed = read_csv_bytes(data)
    return {"filename": file.filename, **parsed}
```

---

## backend/app/main.py
```
import os
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from .routes import router as api_router

app = FastAPI(title="Legacy Data Extractor – API", version="0.1.0")

origins_env = os.getenv("CORS_ORIGINS", "*")
origins = [o.strip() for o in origins_env.split(",") if o.strip()]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins if origins else ["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

app.include_router(api_router)


@app.get("/")
async def root():
    return {"app": "Legacy Data Extractor API", "version": "0.1.0"}
```

---

## frontend/package.json
```
{
  "name": "legacy-data-extractor-web",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "18.3.1",
    "react-dom": "18.3.1"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "4.3.1",
    "vite": "5.4.10"
  }
}
```

---

## frontend/vite.config.js
```
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
  },
  define: {
    __API_URL__: JSON.stringify(process.env.VITE_API_URL || 'http://localhost:8000')
  }
})
```

---

## frontend/index.html
```
<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Legacy Data Extractor</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
```

---

## frontend/src/main.jsx
```
import React from 'react'
import { createRoot } from 'react-dom/client'
import App from './App'

createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
)
```

---

## frontend/src/App.jsx
```
import React, { useState } from 'react'
import UploadForm from './components/UploadForm'
import DataTable from './components/DataTable'

export default function App() {
  const [data, setData] = useState(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')

  return (
    <div style={{ maxWidth: 960, margin: '40px auto', padding: 16, fontFamily: 'system-ui, sans-serif' }}>
      <h1>Legacy Data Extractor</h1>
      <p>Upload a CSV to preview the parsed data.</p>
      <UploadForm setData={setData} setLoading={setLoading} setError={setError} />

      {loading && <p>Parsing…</p>}
      {error && <p style={{ color: 'crimson' }}>{error}</p>}
      {data && <DataTable headers={data.headers} rows={data.rows} filename={data.filename} />}
    </div>
  )
}
```

---

## frontend/src/components/UploadForm.jsx
```
import React, { useRef } from 'react'

const API_URL = (import.meta.env.VITE_API_URL) || window.__API_URL__ || 'http://localhost:8000'

export default function UploadForm({ setData, setLoading, setError }) {
  const fileRef = useRef(null)

  const onSubmit = async (e) => {
    e.preventDefault()
    setError('')

    const file = fileRef.current?.files?.[0]
    if (!file) {
      setError('Please choose a CSV file')
      return
    }

    const form = new FormData()
    form.append('file', file)

    setLoading(true)
    try {
      const res = await fetch(`${API_URL}/api/upload`, {
        method: 'POST',
        body: form
      })
      if (!res.ok) throw new Error(`Upload failed (${res.status})`)
      const json = await res.json()
      setData(json)
    } catch (err) {
      setError(err.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <form onSubmit={onSubmit} style={{ marginBottom: 24 }}>
      <input type="file" accept=".csv,text/csv" ref={fileRef} />
      <button type="submit" style={{ marginLeft: 12 }}>Upload</button>
    </form>
  )
}
```

---

## frontend/src/components/DataTable.jsx
```
import React from 'react'

export default function DataTable({ headers = [], rows = [], filename }) {
  return (
    <div>
      <h3 style={{ marginTop: 24 }}>Preview: {filename}</h3>
      <div style={{ overflowX: 'auto', border: '1px solid #ddd', borderRadius: 8 }}>
        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
          <thead>
            <tr>
              {headers.map((h, i) => (
                <th key={i} style={{ textAlign: 'left', padding: 8, borderBottom: '1px solid #eee' }}>{h || `Column ${i+1}`}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {rows.map((row, idx) => (
              <tr key={idx}>
                {headers.map((h, i) => (
                  <td key={i} style={{ padding: 8, borderBottom: '1px solid #f5f5f5' }}>{row[h]}</td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <p style={{ color: '#666', marginTop: 8 }}>Showing up to 500 rows for preview.</p>
    </div>
  )
}
```

---

## infra/docker-compose.yml
```
version: '3.9'
services:
  api:
    build: ./../backend
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    environment:
      - CORS_ORIGINS=*
  web:
    working_dir: /app
    image: node:20-alpine
    volumes:
      - ../frontend:/app
    command: sh -c "npm install && npm run dev -- --host"
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:8000
```

---

## infra/render.yaml
```
services:
  - type: web
    name: data-extractor-api
    env: python
    buildCommand: pip install -r backend/requirements.txt
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port 10000
    autoDeploy: true
    envVars:
      - key: PYTHON_VERSION
        value: 3.11
      - key: CORS_ORIGINS
        value: "*"
    plan: free
    region: oregon
    buildFilter:
      paths:
        - backend/**
    
  - type: static
    name: data-extractor-web
    env: static
    buildCommand: |
      cd frontend && npm install && npm run build
    staticPublishPath: frontend/dist
    pullRequestPreviewsEnabled: true
    envVars:
      - key: VITE_API_URL
        fromService:
          type: web
          name: data-extractor-api
          envVarKey: RENDER_EXTERNAL_URL
    buildFilter:
      paths:
        - frontend/**
```

---

## backend/Dockerfile (optional if you want to build the api image)
```
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt
COPY app ./app
EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
